# Copyright 2012 United States Government, as represented by the Secretary of Defense, Under
# Secretary of Defense (Personnel & Readiness).
# 
# Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except
# in compliance with the License. You may obtain a copy of the License at
# 
#   http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software distributed under the License
# is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
# or implied. See the License for the specific language governing permissions and limitations under
# the License.

---
extends: http://vwf.example.com/lesson/task.vwf
properties:
  scenePath: /
children:
  enterVehicle:
    extends: http://vwf.example.com/lesson/task.vwf
    properties:
      text: "1.0 Enter the Vehicle"
      cameraPoseRef: /lesson/cameraPose1
    children:
      walkToVehicle:
        extends: http://vwf.example.com/lesson/task.vwf
        properties:
          text: "1.1 Walk to the vehicle"
        children:
          walkInstructions:
            extends: http://vwf.example.com/lesson/task.vwf
            properties:
              text: "Use WASD to navigate to the vehicle door."
            scripts:
            - |
              this.entering = function() {
                this.logger.info( "Step: Walk to Vehicle" );
                var app = this.parent.parent.parent.parent;
                app.keyUp = this.events.add( function() {
                  var trans = app.camera.translation;
                  if( trans[0] > -55 && trans[0] < 45 && trans[1] > -200 && trans[1] < -100 && trans[2] > 35 && trans[2] < 95 )
                  {
                    app.keyUp = app.events.flush( this );
                    this.logger.info( "Step: Walk to Vehicle - Completed" );
                    this.completed();
                  }
                }, this );
              }
      openDoor:
        extends: http://vwf.example.com/lesson/task.vwf
        properties:
          text: "1.2 Open vehicle door"
        children:
          openDoorInstructions:
            extends: http://vwf.example.com/lesson/task.vwf
            properties:
              text: "Click on the door to open it."
            scripts:
            - |
              this.entering = function() {
                this.logger.info( "Step: Open Door" );
                var humveeDoor = this.find( "/humvee/DoorDriverFront" )[ 0 ];
                humveeDoor.pointerUp = humveeDoor.events.add( function() {
                  var app = this.parent.parent.parent.parent;
                  if(app.humvee.DoorDriverFront.controlValue == 0)
                  {
                    humveeDoor.pointerUp = humveeDoor.events.flush( this );
                    this.logger.info( "Step: Open Door - Completed" );
                    this.completed();
                  }
                }, this );
              }
      jumpIn:
        extends: http://vwf.example.com/lesson/task.vwf
        properties:
          text: "1.3 Jump into the driver's seat"
        children:
          jumpInInstructions:
            extends: http://vwf.example.com/lesson/task.vwf
            properties:
              text: "Click on the vehicle's driver seat to jump in."
            scripts:
            - |
              this.entering = function() {
                this.logger.info( "Step: Jump In" );
                var humvee = this.find( "/humvee/HumveeBody" )[ 0 ];
                humvee.pointerClick = humvee.events.add( function() {
                  humvee.pointerClick = humvee.events.flush( this );
                  this.logger.info( "Step: Jump In - Completed" );
                  this.completed();
                }, this );
              }
      closeDoor:
        extends: http://vwf.example.com/lesson/task.vwf
        properties:
          text: "1.4 Close vehicle door"
          cameraPoseRef: /lesson/cameraPose14
        children:
          closeDoorInstructions:
            extends: http://vwf.example.com/lesson/task.vwf
            properties:
              text: "Click on the door to close it."
            scripts:
            - |
              this.entering = function() {
                this.logger.info( "Step: Close Door" );
                var humveeDoor = this.find( "/humvee/DoorDriverFront" )[ 0 ];
                humveeDoor.pointerUp = humveeDoor.events.add( function() {
                  humveeDoor.pointerUp = humveeDoor.events.flush( this );
                  this.logger.info( "Step: Close Door - Completed" );
                  this.completed();
                }, this );
              }
  startEngine:
    # Move rotary ignition switch to run
    # Wait for wait to start lamp above the switch goes out
    # Turn the switch to the start position to engage the starter to crank the engine
    # Once the engine starts, release the switch and it will automatically return to the run position
    # Check engine oil pressure, coolant temperature, volt meter, and a fuel gauges for proper readings
    extends: http://vwf.example.com/lesson/task.vwf
    properties:
      text: "2.0 Start the Engine"
      cameraPoseRef: /lesson/cameraPose2
    children:
      moveIgnitionToRun:
        extends: http://vwf.example.com/lesson/task.vwf
        properties:
          text: "2.1 Move ignition to RUN"
        children:
          runIgnitionInstructions:
            extends: http://vwf.example.com/lesson/task.vwf
            properties:
              text: "Click on the rotary ignition switch to the left of the steering wheel to move it to RUN position."
            scripts:
            - |
              this.entering = function() {
                this.logger.info( "Step: Set Ignition to Run" );
                var ignition = this.find( "/humvee/Ignition" )[ 0 ];
                ignition.pointerUp = ignition.events.add( function() {
                  ignition.pointerUp = ignition.events.flush( this );
                  this.logger.info( "Step: Set Ignition to Run - Completed" );
                  this.completed();
                }, this );
              }
          waitForLightInstructions:
            extends: http://vwf.example.com/lesson/task.vwf
            properties:
              text: "Wait for the 'wait to start' lamp above the switch to go out."    
            scripts:
            - |
              this.entering = function() {
                this.logger.info( "Step: Wait for Light" );
                this.in(3).completed();                
                this.logger.info( "Step: Wait for Light - Completed" );
              }
      moveIgnitionToStart:
        extends: http://vwf.example.com/lesson/task.vwf
        properties:
          text: "2.2 Move ignition to START"
        children:
          startIgnitionInstructions:
            extends: http://vwf.example.com/lesson/task.vwf
            properties:
              text: "Drag the rotary ignition switch to START position. Release the switch, and it will automatically return to the RUN position."
            scripts:
            - |
              this.entering = function() {
                this.logger.info( "Step: Set Ignition to Start" );
                var ignition = this.find( "/humvee/Ignition" )[ 0 ];
                ignition.pointerUp = ignition.events.add( function() {
                  ignition.pointerUp = ignition.events.flush( this );
                  this.logger.info( "Step: Set Ignition to Start - Completed" );
                  this.completed();
                }, this );
              }
          checkGauges:
            extends: http://vwf.example.com/lesson/task.vwf
            properties:
              text: "Check the engine oil pressure, coolant temperature, volt meter, and fuel gauges for proper readings."
            scripts:
            - |
              this.entering = function() {
                this.logger.info( "Step: Set Ignition to Start" );
                this.in(5).completed();
              }
  driveVehicle:
    # With parking break applied, move the transmission range selector from the N to the D position.
    # Release the parking break and ensure brake warning light goes out
    # Move vehicle forward
    extends: http://vwf.example.com/lesson/task.vwf
    properties:
      text: "3.0 Drive Vehicle"
      cameraPoseRef: /lesson/cameraPose3
    children:
      moveToDrive:
        extends: http://vwf.example.com/lesson/task.vwf
        properties:
          text: "3.1 Move transmission to drive"
          cameraPoseRef: /lesson/cameraPose31
        children:
          moveToDriveInstructions:
            extends: http://vwf.example.com/lesson/task.vwf
            properties:
              text: "With parking break applied, click and drag the transmission range selector from the N to the D position." 
            scripts:
            - |
              this.entering = function() {
                this.logger.info( "Step: Move Gear Shift to Drive" );
                var gearShift = this.find( "/humvee/GearShift" )[ 0 ];
                gearShift.pointerUp = gearShift.events.add( function() {
                  gearShift.pointerUp = gearShift.events.flush( this );
                  this.logger.info( "Step: Move Gear Shift to Drive - Completed" );
                  this.completed();
                }, this );
              } //@ sourceURL=moveToDriveTask.vwf
      releaseBrake:
        extends: http://vwf.example.com/lesson/task.vwf
        properties:
          text: "3.2 Release parking break"
        children:
          releaseBrakeInstructions:
            extends: http://vwf.example.com/lesson/task.vwf
            properties:
              text: "Click the parking brake to release it, and ensure brake warning light goes out." 
            scripts:
            - |
              this.entering = function() {
                this.logger.info( "Step: Release Parking Brake" );
                var parkingBrake = this.find( "/humvee/EmergencyBrake" )[ 0 ];
                parkingBrake.pointerUp = parkingBrake.events.add( function() {
                  parkingBrake.pointerUp = parkingBrake.events.flush( this );
                  this.logger.info( "Step: Release Parking Brake - Completed" );
                  this.completed();
                }, this );
              } //@ sourceURL=releaseBrakeTask.vwf
      moveVehicle:
        extends: http://vwf.example.com/lesson/task.vwf
        properties:
          text: "3.3 Drive vehicle forward"
          cameraPoseRef: /lesson/cameraPose33
        children:
          moveVehicleInstructions:
            extends: http://vwf.example.com/lesson/task.vwf
            properties:
              text: "" 
            scripts:
            - |
              this.entering = function() {
                // UPDATE
              } //@ sourceURL=moveVehicleTask.vwf
        scripts:
        - |
          this.cameraTransformComplete = function() {
            // Switch cameras here
          } //@ sourceURL=moveVehicleTask.vwf
  cameraPose1:
    extends: http://vwf.example.com/node3.vwf
    properties:
      translation: [ 150, -360, 74 ]
      rotation: [ 0, 0, 1, 30 ]
  cameraPose14:
    extends: http://vwf.example.com/node3.vwf
  cameraPose2:
    extends: http://vwf.example.com/node3.vwf
  cameraPose3:
    extends: http://vwf.example.com/node3.vwf
  cameraPose31:
    extends: http://vwf.example.com/node3.vwf
  cameraPose33:
    extends: http://vwf.example.com/node3.vwf
scripts:
- |
  this.initialize = function() {
    this.cameraPose14.transform = [-0.8957634568214417,0.44452738761901855,0,0,
      -0.44452738761901855,-0.8957634568214417,0,0,
      0,0,1,0,
      -14.165600776672363,-7.067508220672607,75,1];

    this.cameraPose2.transform = [ 
      -0.4162047505378723,0.9092690348625183,0,0,
      -0.9092690348625183,-0.4162047505378723,0,0,
      0,0,1,0,
      -6.781380653381348,-22.743375778198242,76.43529510498047,1 ];

    this.cameraPose3.transform = [0.9015761017799377,0.43261784315109253,0,0,
      -0.43261784315109253,0.9015761017799377,0,0,
      0,0,1,0,
      -21.921772003173828,-45.81437301635742,63.3342170715332,1];

    // changing transmission and brake
    this.cameraPose31.transform = [ 0.8790436387062073,0.4767311215400696,-0.000013773170394415502,0,
    -0.43207061290740967,0.7966820001602173,-0.42261648178100586,0,
    -0.20146524906158447, 0.37150758504867554,0.9063078165054321,0,
    -13.254499435424805,-45.380226135253906,86.13629150390625,1 ];

    // driving position
    this.cameraPose33.transform = [ 0.045417796820402145,0.9989691972732544,0,0,
      -0.9989691972732544,0.045417796820402145,0,0,
      0,0,1,0,
      -14.136186599731445,-42.1671028137207,88.4365005493164,1 ];

  } //@ sourceURL=humvee-lesson.vwf
